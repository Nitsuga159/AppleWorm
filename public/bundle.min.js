(()=>{"use strict";class t{constructor({frames:t,from:e,to:i,cb:s,onEnd:n}){this.currentFrame=0,this.frames=t,this.from=e,this.to=i,this.cb=s,this.onEnd=n}update(){this.isEnd()||(this.cb((this.to-this.from)/this.frames),this.currentFrame++,this.isEnd()&&this.onEnd())}isEnd(){return this.currentFrame>=this.frames}}class e{static init({id:t,width:i,height:s}){if(e.canvas=document.getElementById(t),!e.canvas)throw new Error("Canvas HTML Element not found");e.canvas.width=i,e.canvas.height=s,e.ctx=e.canvas.getContext("2d"),e.ctx.imageSmoothingEnabled=!1}static getSize(){return[e.canvas.width,e.canvas.height]}static getCanvas(){return e.canvas}static getCtx(){return e.ctx}}class i{constructor({width:t,height:e,x:i,y:s}){this.prevX=0,this.prevY=0,this.width=t,this.height=e,this.x=i,this.y=s}getX(){return this.x}getY(){return this.y}getLocation(){return[this.x,this.y]}getWidth(){return this.width}getHeight(){return this.height}getBounds(){return[this.x,this.y,this.width,this.height]}setX(t){return this.prevX=this.x,this.x=t,this}addX(t){return this.x+=t,this}setY(t){return this.prevY=this.y,this.y=t,this}addY(t){return this.y+=t,this}setLocation(t,e){return this.prevX=this.x,this.prevY=this.y,this.x=t,this.y=e,this}setWidth(t){return this.width=t,this}setHeight(t){return this.height=t,this}setBounds(t,e,i,s){return this.prevX=this.x,this.prevY=this.y,this.x=t,this.y=e,this.width=i,this.height=s,this}getPrevLocation(){return[this.prevX,this.prevY]}getPrevX(){return this.prevX}getPrevY(){return this.prevY}isInArea({x:t,y:e}){return t>=this.getX()&&t<=this.getX()+this.getWidth()&&e>=this.getY()&&e<=this.getY()+this.getHeight()}static matchLocation(t,e){return t[0]===e[0]&&t[1]===e[1]}}var s;!function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(s||(s={}));var n=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};const r=function(t){return class extends t{constructor(...t){var e,i,s,r,o;let a=t[0],{frame:h}=a;h=h||{},super(n(a,["frame"])),this.increment=1,(null==h?void 0:h.textureId)&&(this.textureId=h.textureId,this.texture=document.getElementById(h.textureId)),this.index=h.index,this.spin=h.spin||0,this.delX=h.delX||0,this.delY=h.delY||0,this.columns=h.columns||1,this.rows=h.rows||1,this.totalFrames=null!==(e=h.totalFrames)&&void 0!==e?e:1,this.frameSize=h.frameSize,this.frameWidth=h.frameWidth,this.frameHeight=h.frameHeight,this.flip=null!==(i=h.flip)&&void 0!==i&&i,this.syncLocation=null===(s=h.syncLocation)||void 0===s||s,this.frameX=null!==(r=h.frameX)&&void 0!==r?r:this.getX(),this.frameY=null!==(o=h.frameY)&&void 0!==o?o:this.getY()}drawFrame(){}getFrameProperty(t){return this[t]}setFrameProperty(t,e){this[t]=e,"syncLocation"===t&&!1===e&&(this.frameX=this.getX(),this.frameY=this.getY())}getFrameCoordinates(){if(!this.texture)return null;return{x:(this.index-1)%this.columns*this.frameSize,y:Math.floor((this.index-1)/this.columns)*this.frameSize}}nextFrame(){this.texture&&(this.index=this.index%this.totalFrames+1)}rotate(){this.texture&&(this.spin=(this.spin+90)%360)}nextFrameWithReverse(){this.texture&&(1===this.index?this.increment=1:this.index===this.totalFrames&&(this.increment=-1),this.index+=this.increment)}paintFrame(t){if(!this.texture)return;const e=this.syncLocation?this.getX():this.frameX,i=this.syncLocation?this.getY():this.frameY,s=this.spin*Math.PI/180;t.save(),t.translate(e+this.frameSize/2+this.delX,i+this.frameSize/2+this.delY),s&&t.rotate(s),this.flip&&t.scale(-1,1);const{x:n,y:r}=this.getFrameCoordinates();t.drawImage(this.texture,n,r,this.frameSize,this.frameSize,-this.frameSize/2,-this.frameSize/2,this.frameSize,this.frameSize),t.restore()}}};var o=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class a extends(r(function(t){return class extends t{itemCollision(t,e){const[i,n,r,o]=t.getBounds(),[a,h,c,l]=e.getBounds();if(!!(i>a+c||i+r<a||n>h+l||n+o<h))return null;var d=i+r/2-(a+c/2),u=n+o/2-(h+l/2),g=r/2+c/2,m=o/2+l/2,p=d>0?g-d:-g-d,y=u>0?m-u:-m-u;return 0!=p&&0!=y?Math.abs(p)<Math.abs(y)?p<0?s.LEFT:s.RIGHT:y<0?(this.setY(e.getY()-this.getHeight()),s.TOP):(this.setY(e.getY()+e.getHeight()),s.BOTTOM):void 0}isBottom(t,e){if(this.isInX(t,e)&&t.getY()<=e.getY()+e.getHeight())return{target:e,direction:s.BOTTOM}}isTop(t,e){if(this.isInX(t,e)&&t.getY()>=e.getY())return{target:e,direction:s.TOP}}isRight(t,e){if(this.isInY(t,e)&&t.getX()<=e.getX()+e.getWidth())return{target:e,direction:s.RIGHT}}isLeft(t,e){if(this.isInY(t,e)&&t.getX()>=e.getX())return{target:e,direction:s.LEFT}}isInY(t,e){const i=t.getY(),s=t.getHeight(),n=e.getY(),r=e.getHeight();return i+s>=n&&i<=n+r}isInX(t,e){const i=t.getX(),s=t.getWidth(),n=e.getX(),r=e.getWidth();return i+s>=n&&i<=n+r}}}(i))){constructor(t){var{fill:e,group:i,target:s,debug:n,paintPriority:r}=t;super(o(t,["fill","group","target","debug","paintPriority"])),this.functionalities=[],this.opacity=1,this.constructor.ALL_ITEMS||(this.constructor.ALL_ITEMS=[]),this.debug=n||!1,this.fill=e,this.target=s||[],this.group=i||[],this.paintPriority=r||0,this.constructor.ALL_ITEMS.push(this)}static getAllItems(){return this.ALL_ITEMS||[]}static resetAllItems(){this.ALL_ITEMS=[]}static removeItem(t){this.ALL_ITEMS=this.ALL_ITEMS.filter((e=>e!==t))}setGroup(t){return this.group=t,this}setTarget(t){return this.target=t,this}setPaintPriority(t){this.paintPriority=t}setOpacity(t){this.opacity=t}getOpacity(){return this.opacity}getPaintPriority(){return this.paintPriority}getFill(){return this.fill}getTarget(){return this.target}getGroup(){return this.group}getFunctionalities(){return this.functionalities}addFunctionality(t){return this.functionalities.push(t),this}matchLocation(t){return this.getX()===t.getX()&&this.getY()===t.getY()}isDebug(){return this.debug}setIsDebug(t){this.debug=t}automaticRemove(){return!0}}class h extends a{update(){}paint(t){if(t.globalAlpha=this.getOpacity(),this.getFrameProperty("textureId")?this.paintFrame(t):(t.fillStyle=this.fill||h.DEFAULT_FILL,t.fillRect(...this.getBounds())),this.isDebug()){t.strokeStyle="red",t.lineWidth=4;const[e,i,s,n]=this.getBounds();t.beginPath(),t.moveTo(e+2,i+2),t.lineTo(e+s-2,i+2),t.lineTo(e+s-2,i+n-2),t.lineTo(e+2,i+n-2),t.closePath(),t.stroke()}}shouldPaint(){const[t,i]=e.getSize(),[s,n,r,o]=this.getBounds();return s+r>=0&&s<=t&&n+o>=0&&n<=i}}h.DEFAULT_FILL="#000";const c=h,l={SIZE:50,GRAVITY:8};var d=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))},u=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class g extends c{constructor(t){var{x:e,y:i,canMove:s,canRotate:n}=t,r=u(t,["x","y","canMove","canRotate"]);super(Object.assign(Object.assign({},r),{x:e*l.SIZE,y:i*l.SIZE})),this.nextX=0,this.nextY=0,this.transitionX=null,this.transitionY=null,this.last=!1,this.nextX=e*l.SIZE,this.nextY=i*l.SIZE,this.canMove=s,this.canRotate=n}copy(){return new this.constructor({x:this.getX()/l.SIZE,y:this.getY()/l.SIZE,width:this.getWidth(),height:this.getHeight(),frame:{index:this.getFrameProperty("index"),frameSize:this.getFrameProperty("frameSize"),textureId:this.getFrameProperty("textureId")}})}isMoving(){return null!==this.transitionX||null!==this.transitionY}update(){var t,e;null===(t=this.transitionX)||void 0===t||t.update(),null===(e=this.transitionY)||void 0===e||e.update()}getCanMove(){return this.canMove}getCanRotate(){return this.canRotate}getTransitionX(){return this.transitionX}getTransitionY(){return this.transitionY}getNextX(){return this.nextX}getNextY(){return this.nextY}setNextX(t){this.nextX=t}setNextY(t){this.nextY=t}getNextLocation(){return[this.nextX,this.nextY]}getDistanceX(t){return this.getX()-t.getX()}getDistanceY(t){return this.getY()-t.getY()}getDistance(t){return[this.getDistanceX(t),this.getDistanceY(t)]}setTransition({next:e,dir:i,onEnd:s,onlyFrame:n,frames:r=10}){const o=n?()=>this.getFrameProperty(`frame${i}`):()=>this[`get${i}`](),a=n?t=>this.setFrameProperty(`frame${i}`,o()+t):t=>this[`add${i}`](t);this[`next${i}`]=e,this[`transition${i}`]=new t({frames:r,from:o(),to:e,cb:a,onEnd:()=>{this[`transition${i}`]=null,s&&s()}})}setTransitionFrameY(t,e){this.setTransition({next:t,dir:"Y",onEnd:e,onlyFrame:!0})}setTransitionFrameX(t,e){this.setTransition({next:t,dir:"X",onEnd:e,onlyFrame:!0})}setTransitionY(t,e,i){this.setTransition({next:t,dir:"Y",onlyFrame:e,onEnd:()=>{this.setY(t),i&&i()}})}setTransitionX(t,e,i){this.setTransition({next:t,dir:"X",onlyFrame:e,onEnd:()=>{this.setX(t),i&&i()}})}setChainTransition(t,e){return d(this,void 0,void 0,(function*(){this.setFrameProperty("syncLocation",!1);for(let i=0;i<t.length;i++){i===t.length-3&&(this.last=!0);const{x:s,y:n}=t[i];yield new Promise((t=>{let e=!1,i=!1;this.setTransitionFrameX(s,(()=>{e=!0,i&&t(1)})),this.setTransitionFrameY(n,(()=>{i=!0,e&&t(1)}))})),e&&e()}}))}}var m=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class p extends g{constructor(t){var{index:e,spin:i}=t,s=m(t,["index","spin"]);super(Object.assign(Object.assign({},s),{width:l.SIZE,height:l.SIZE,canMove:!0,canRotate:!1,paintPriority:6,frame:{index:e,textureId:"apple",columns:1,frameSize:55,delX:-2,delY:-2,spin:i},group:[p]}))}onWormHeadCollide(t,e){return e.getWorm().enlarge(),!0}}var y=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class f extends g{constructor(t){var{index:e,spin:i}=t,s=y(t,["index","spin"]);super(Object.assign(Object.assign({},s),{width:l.SIZE,height:l.SIZE,canMove:!0,canRotate:!1,paintPriority:10,frame:{index:e,textureId:"block",columns:6,rows:5,frameSize:50,spin:i},group:[f]}))}onWormHeadCollide(t,e){return!1}}class v{static addListener(t,i){var s;this.eventsController.has(t)||(this.eventsController.set(t,[]),e.getCanvas().addEventListener(t,(i=>{var s;if(void 0!==i.clientX&&void 0!==i.clientY){const[n,r]=((t,i)=>{const s=e.getCanvas(),n=s.width,r=s.height,o=n/s.clientWidth,a=r/s.clientHeight;return[(t-s.offsetLeft)*o,(i-s.offsetTop)*a]})(i.clientX,i.clientY);null===(s=this.eventsController.get(t))||void 0===s||s.forEach((t=>{t({clientX:n,clientY:r})}))}}))),null===(s=this.eventsController.get(t))||void 0===s||s.push(i)}static deleteListener(t,e){const i=this.eventsController.get(t);i&&this.eventsController.set(t,i.filter((t=>t!==e)))}}v.eventsController=new Map;const P=v;class x{constructor({baseItem:t,onChange:e}){this.enabled=!0,this.pressed=!1,this.onChange=e,this.onMouseDown=e=>{var i;let s=this.pressed;this.pressed=t.isInArea({x:e.clientX,y:e.clientY}),s!==this.pressed&&(null===(i=this.onChange)||void 0===i||i.call(this,this.pressed,e))},this.onMouseUp=t=>{var e;this.pressed&&(this.pressed=!1,null===(e=this.onChange)||void 0===e||e.call(this,this.pressed,t))},P.addListener("mousedown",this.onMouseDown),P.addListener("mouseup",this.onMouseUp)}setOnChange(t){this.onChange=t}enable(){this.enabled||(P.addListener("mousedown",this.onMouseDown),P.addListener("mouseup",this.onMouseUp))}disable(){this.enabled&&(P.deleteListener("mousedown",this.onMouseDown),P.deleteListener("mouseup",this.onMouseUp),this.enabled=!1)}isEnabled(){return this.enabled}isPressed(){return this.pressed}}class I{constructor({target:t,encapsulate:e,canMove:i,onNewLocation:s}){this.enabled=!0,this.prevLocation={x:0,y:0},this.onNewLocation=s,this.mousePress=new x({baseItem:t,onChange:e=>{var i;e?this.prevLocation={x:t.getX(),y:t.getY()}:null===(i=this.onNewLocation)||void 0===i||i.call(this,{x:t.getX(),y:t.getY()})}});let n=0,r=0;this.onMouseMove=({clientX:s,clientY:o})=>{!n||!r||e&&!this.mousePress.isPressed()||i&&!i()||t.addX(s-n).addY(o-r),n=s,r=o},P.addListener("mousemove",this.onMouseMove)}enable(){this.enabled||P.addListener("mousemove",this.onMouseMove)}disable(){this.enabled&&(P.deleteListener("mousemove",this.onMouseMove),this.enabled=!1)}isEnabled(){return this.enabled}getPrevLocation(){return this.prevLocation}setOnNewLocation(t){this.onNewLocation=t}}class E{constructor(){this.items=[]}get(){return this.items}add(t){this.items.push(t)}remove(t){this.items=this.items.filter((e=>e!==t)),t.constructor.removeItem(t)}reset(){this.items=[]}}class b extends E{constructor(){super(),b.instances.push(this)}execute(t){const i=e.getCtx(),s=e.getCanvas();i.clearRect(0,0,s.width,s.height),this.get().sort(((t,e)=>t.getY()<e.getY()?-1:1)),this.get().forEach((t=>{t.getFunctionalities().forEach((e=>e.isEnabled()&&e.applicate(t,this))),t.update()})),t(this),this.get().filter((t=>t.shouldPaint())).slice().forEach((t=>{i.save(),t.paint(i),i.restore()})),requestAnimationFrame((()=>this.execute.call(this,t)))}forEachItemConstructor(t,e){for(let i of t)for(let t of i.getAllItems()||[])if(e(t))return}static getLoops(){return b.instances}}b.instances=[];const w=b;class F extends w{constructor(){super(...arguments),this.itemConstructors=[]}loadItemConstructor(...t){return this.itemConstructors.push(...t),this}getItemConstructors(){return this.itemConstructors.slice()}reset(){return this.itemConstructors.forEach((t=>t.resetAllItems())),this}}class O{constructor(){this.enabled=!0}isEnabled(){return this.enabled}setIsEnabled(t){this.enabled=t}}class L extends O{constructor({velocity:t}){super(),this.velocity=t}applicate(t,e){t.setY(t.getY()+this.velocity)}setVelocity(t){this.velocity=t}}var S=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class C extends g{constructor(t){var{index:e,spin:i}=t,s=S(t,["index","spin"]);super(Object.assign(Object.assign({},s),{paintPriority:98,canMove:!1,canRotate:!1,width:l.SIZE,height:l.SIZE,frame:{index:e,textureId:"worm",columns:2,frameSize:50,spin:i},group:[C],target:[T,f,p,D]}))}update(){}copy(){const t=super.copy();return t.setFrameProperty("index",this.getFrameProperty("index")),t.setFrameProperty("spin",this.getFrameProperty("spin")),t}getSide(t,e){return t.getX()-e.getX()<0?{dir:"LEFT",hole:[3*Math.PI/2,Math.PI/2]}:t.getX()-e.getX()>0?{dir:"RIGHT",hole:[Math.PI/2,3*Math.PI/2]}:t.getY()-e.getY()<0?{dir:"TOP",hole:[0,Math.PI]}:{dir:"BOTTOM",hole:[Math.PI,2*Math.PI]}}paint(t){if(k.getWonPiece()&&this.last){const e=k.getWonPiece().slice(0,-2),i=e.at(-1);t.beginPath();const{dir:s,hole:n}=this.getSide(e.at(-2),i),r=l.SIZE/2,o=i.getFrameProperty("frameSize")/2;t.arc(i.getX()+r,i.getY()+r,o,...n);const a=this.getFrameProperty("frameY")+(this.getFrameProperty("delY")||0),h=this.getFrameProperty("frameX")+(this.getFrameProperty("delX")||0),c=this.getFrameProperty("frameSize");"LEFT"===s?(t.lineTo(i.getX()+r,a+c),t.lineTo(h,a+c),t.lineTo(h,a),t.lineTo(h+c,a)):"RIGHT"===s?(t.lineTo(i.getX()+r,a),t.lineTo(h+c,a),t.lineTo(h+c,a+c),t.lineTo(h,a+c)):"TOP"===s?(t.lineTo(h,i.getY()+r),t.lineTo(h,a),t.lineTo(h+c,a),t.lineTo(h+c,a+c)):(t.lineTo(h+c,i.getY()+r),t.lineTo(h+c,a),t.lineTo(h+c,a+c),t.lineTo(h,a+c)),t.closePath(),t.clip()}super.paint(t)}onWormHeadCollide(t,e){return!1}}var Y=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class T extends g{constructor(t){var{index:e,spin:i}=t,s=Y(t,["index","spin"]);super(Object.assign(Object.assign({},s),{paintPriority:11,width:l.SIZE,height:l.SIZE,canMove:!0,canRotate:!1,frame:{index:e,textureId:"stone",columns:1,frameSize:55,spin:i},group:[T],target:[C,f,p,T,D]})),this.gravity=new L({velocity:l.GRAVITY}),this.falling=!1,this.addFunctionality(this.gravity),this.falling=!1}getFalling(){return this.falling}getGravity(){return this.gravity}update(){super.update(),this.falling=!0,k.forEachItemConstructor(this.getTarget(),(t=>{if(t!==this&&this.itemCollision(this,t)===s.TOP)return this.setY(t.getY()-this.getHeight()),this.falling=!1,!0}))}onWormHeadCollide(t,e){if(this.falling)return!1;const i=e,[s,n]=j.floorCoords(this.getDistance(t)),r=i.getFrom([this.getX()+s,this.getY()+n]);return!this.getTarget().some((t=>r instanceof t))&&(this.gravity.setIsEnabled(!1),s?this.setTransitionX(this.getX()+s,!1,(()=>this.gravity.setIsEnabled(!0))):this.setTransitionY(this.getY()+n,!1,(()=>this.gravity.setIsEnabled(!0))),!0)}}class X{constructor(t){this.gravity=new L({velocity:l.GRAVITY}),t.forEach((t=>k.add(t.addFunctionality(this.gravity)))),this.pieces=t,X.audio.pause()}static playAudio(t){X.audio.src=`assets/audios/${t[Math.floor(Math.random()*t.length)]}.mp3`,X.audio.play()}setFalling(t){this.gravity.setIsEnabled(t)}isFalling(){return this.gravity.isEnabled()}onCollide(){this.gravity.setIsEnabled(!1),this.pieces.forEach((t=>{t.setY(Math.round(t.getY()/l.SIZE)*l.SIZE),t.setNextY(t.getY())})),this.checkQueueFrame(),this.checkEndFrame(),this.hasMoves()||X.playAudio(X.NO_MOVES_AUDIOS)}update(){this.pieces.forEach((t=>{var e,i;null===(e=t.getTransitionX())||void 0===e||e.update(),null===(i=t.getTransitionY())||void 0===i||i.update()})),this.pieces.forEach((t=>{k.forEachItemConstructor(t.getTarget(),(e=>{if(!t.isMoving()&&t.itemCollision(t,e)===s.TOP){if(e instanceof T&&k.getFrom([e.getX(),e.getY()+l.SIZE])instanceof C)return;this.onCollide()}}))}))}getPieces(){return this.pieces}getQueue(){return this.pieces.slice(1)}getHead(){return this.pieces[0]}getEnd(){return this.pieces.at(-1)}isMoving(){return this.pieces.some((t=>t.isMoving()))}enlarge(){const t=this.pieces.at(-1).copy().addFunctionality(this.gravity);k.add(t),this.pieces.push(t)}isVertical(){return this.getQueue().every((t=>t.getX()===this.getHead().getX()))}hasMoves(){const t=this.getHead(),[e,i]=t.getLocation(),s=k.getFrom([e-l.SIZE,i]),n=k.getFrom([e+l.SIZE,i]),r=k.getFrom([e,i-l.SIZE]),o=k.getFrom([e,i+l.SIZE]);if(this.isVertical()&&s instanceof f&&n instanceof f&&!r)return!1;if(!(s&&n&&o&&r))return!0;for(let t of[r,o,s,n])if(!(t instanceof C||t instanceof f))return!0;return!1}checkHeadFrame([t,e],[i,s]){const n=this.getHead();t!==i?n.setFrameProperty("spin",i<t?-180:0):n.setFrameProperty("spin",s<e?-90:90)}checkQueueFrame(){const t=this.getPieces().slice();for(let e=1;e<t.length-1;e++){const[i,s]=t[e-1].getNextLocation(),[n,r]=t[e].getNextLocation(),[o,a]=t[e+1].getNextLocation();r===s&&r===a?(t[e].setFrameProperty("index",2),t[e].setFrameProperty("spin",0)):n===i&&n===o?(t[e].setFrameProperty("index",2),t[e].setFrameProperty("spin",90)):i<n&&a>r||o<n&&s>r?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",-90),t[e].setFrameProperty("flip",!1)):s<r&&o<n||a<r&&i<n?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",0),t[e].setFrameProperty("flip",!1)):i>n&&a>r||o>n&&s>r?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",90),t[e].setFrameProperty("flip",!0)):(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",0),t[e].setFrameProperty("flip",!0))}}checkEndFrame(){const t=this.getPieces(),[e,i]=t.at(-1).getNextLocation(),[s,n]=t.at(-2).getNextLocation();e===s&&i>n?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",-90)):e===s&&i<n?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",90)):i===n&&e<s?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",0)):(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",180))}static orderFrames(t){for(let e=1;e<t.length-1;e++){const[i,s]=t[e-1].getNextLocation(),[n,r]=t[e].getNextLocation(),[o,a]=t[e+1].getNextLocation();r===s&&r===a?(t[e].setFrameProperty("index",2),t[e].setFrameProperty("spin",0)):n===i&&n===o?(t[e].setFrameProperty("index",2),t[e].setFrameProperty("spin",90)):i<n&&a>r||o<n&&s>r?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",-90),t[e].setFrameProperty("flip",!1)):s<r&&o<n||a<r&&i<n?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",0),t[e].setFrameProperty("flip",!1)):i>n&&a>r||o>n&&s>r?(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",90),t[e].setFrameProperty("flip",!0)):(t[e].setFrameProperty("index",4),t[e].setFrameProperty("spin",0),t[e].setFrameProperty("flip",!0))}const[e,i]=t.at(-1).getNextLocation(),[s,n]=t.at(-2).getNextLocation();e===s&&i>n?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",-90)):e===s&&i<n?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",90)):i===n&&e<s?(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",0)):(t.at(-1).setFrameProperty("index",3),t.at(-1).setFrameProperty("spin",180))}static checkHeadFrame([t,e],[i,s],n){t!==i?n.setFrameProperty("spin",i<t?-180:0):n.setFrameProperty("spin",s<e?-90:90)}}X.audio=new Audio,X.NO_MOVES_AUDIOS=["ayudame-chavo","pelotudo","miau","error","dross","spongebob-fail"],X.WIN_AUDIOS=["boee","terrorist-wins","orchastra","pvz"];const M=X;class N extends c{constructor(){super({width:30,height:30,x:0,y:0,paintPriority:-1,frame:{textureId:"start",index:1,frameSize:30}}),this.maxExcedation=2e3,this.minExcedation=1500,this.sum=6,this.multiplayer=.5,this.setX(this.getRandomNumber(e.getCanvas().width/2,e.getCanvas().width)),this.setY(-this.getHeight()),this.velocityX=this.getRandomNumber(4,10),this.velocityY=this.getRandomNumber(2,10)}getRandomNumber(t,e){return Math.floor(Math.random()*(e-t)+t)}update(){(this.getX()+this.getWidth()+this.maxExcedation<0||this.getY()-this.getHeight()-this.maxExcedation>e.getCanvas().height)&&(this.setX(this.getRandomNumber(e.getCanvas().width/2,e.getCanvas().width)),this.setY(-this.getHeight()),this.velocityX=this.getRandomNumber(4,10),this.velocityY=this.getRandomNumber(2,10)),this.setFrameProperty("spin",(this.getFrameProperty("spin")+4)%360),this.addX(-this.velocityX),this.addY(this.velocityY)}paint(t){t.globalAlpha=.4,this.paintFrame(t);const e=this.getX(),i=this.getY(),s=this.getWidth()/2,n=s+5+this.sum,r=t.createRadialGradient(e+s,i+s,0,e+s,i+s,n);r.addColorStop(.1,"rgba(255, 255, 255, 0.7)"),r.addColorStop(.5,"rgba(255, 255, 0, 0.4)"),r.addColorStop(1,"rgba(255, 255, 0, 0)"),t.fillStyle=r,t.beginPath(),t.arc(e+s,i+s,s+5+this.sum,0,2*Math.PI),t.fill(),(this.sum<=5||this.sum>=20)&&(this.multiplayer*=-1),this.sum+=this.multiplayer}}const A=new class extends a{shouldPaint(){return this.enabled}automaticRemove(){return!1}constructor(){super({width:30,height:30,x:0,y:0,paintPriority:100}),this.radius=5,this.sum=130,this.enabled=!1}setOnHalf(t){this.onHalf=t}start(){this.enabled||(this.setX(e.getCanvas().width/2),this.setY(e.getCanvas().height/2),this.radius=5,this.sum=130,this.enabled=!0)}update(){this.enabled&&(this.radius+=this.sum,this.radius>=1.5*e.getCanvas().width&&(this.sum=-Math.abs(this.sum),this.onHalf&&this.onHalf()),this.radius<0&&(this.enabled=!1,this.onEnd&&this.onEnd()))}paint(t){const i=e.getCanvas().width/2,s=e.getCanvas().height/2,n=this.radius/2,r=n,o=t.createRadialGradient(i,s,0,i,s,r);o.addColorStop(.1,"rgba(255, 255, 255, 1)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.4)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=o,t.beginPath(),t.arc(i,s,n,0,2*Math.PI),t.fill()}};var H;!function(t){t[t.EDITOR=0]="EDITOR",t[t.NORMAL=1]="NORMAL",t[t.NONE=2]="NONE"}(H||(H={}));class j extends F{constructor(){super(),this.mode=H.NONE,this.stop=!1,this.wonPiece=null,this.add(A)}resizeCanvas(){const t=e.getCanvas(),i=t.width/t.height,s=window.innerWidth,n=window.innerHeight;let r,o;s/n<i?(r=s,o=r/i):(o=n,r=o*i),t.style.width=`${r}px`,t.style.height=`${o}px`}setWonPiece(t){this.wonPiece=t}getWonPiece(){return this.wonPiece}getLoadedJSON(){return this.json}setStop(t){return this.stop=t,this}getStop(){return this.stop}loadJSON(t,s){return A.setOnHalf((()=>{if(Object.keys(t.items).some((t=>void 0===s[t])))throw new Error("Invalid items");if(!t.items.worm)throw new Error("Worm is not defined");if(t.resolution){if(t.resolution.width>3e3||t.resolution.height>2e3||t.resolution.width<300||t.resolution.height<300)throw new Error("Invalid resolution");e.getCanvas().width=t.resolution.width,e.getCanvas().height=t.resolution.height}else e.getCanvas().width=1280,e.getCanvas().height=720;Object.values(s).forEach((t=>t.resetAllItems())),this.get().forEach((t=>t.automaticRemove()&&this.remove(t))),this.stop=!1,this.wonPiece=null,this.name=t.name;const n={};for(let e in t.items)for(let{x:i,y:s}of t.items[e]){if(n[i+"-"+s])throw new Error("Has repeated coords");if(n[i+"-"+s]=1,parseInt(i.toString())!==i||parseInt(s.toString())!==s)throw new Error("Invalid coords")}for(let e in t.items)if("worm"!==e)for(let{x:n,y:r,index:o,spin:a,flip:h}of t.items[e]){const t=new s[e]({x:n,y:r,index:o,spin:a,flip:h});if(this.mode===H.EDITOR&&t.getCanMove()){const e=new I({target:t,encapsulate:!0,onNewLocation:s=>{R.get().some((t=>i.matchLocation(j.roundCoords([s.x,s.y]),t.getLocation())))?t.setLocation(e.getPrevLocation().x,e.getPrevLocation().y):t.setLocation(...j.roundCoords([s.x,s.y]))}})}this.add(t)}this.resizeCanvas(),this.add(new N),this.add(new N),this.add(new N),this.add(new N),this.worm=new M(t.items.worm.map((t=>new C(t)))),this.json=t,this.setStop(!1)})),A.start(),this}getWorm(){return this.worm}setWorm(t){this.worm=t}getItemJSON(t){return t.getAllItems().map((t=>{const e={x:t.getX()/l.SIZE,y:t.getY()/l.SIZE,index:t.getFrameProperty("index")};return t.getFrameProperty("spin")&&(e.spin=t.getFrameProperty("spin")),t.getFrameProperty("flip")&&(e.flip=t.getFrameProperty("flip")),e}))}getJSON(t){const i={name:this.name,resolution:{width:e.getCanvas().width,height:e.getCanvas().height},items:{}};return Object.keys(t).forEach((e=>i.items[e]=this.getItemJSON(t[e]))),i}getFrom(t){for(let e of this.get())if(i.matchLocation(j.floorCoords(t),j.floorCoords(e.getLocation()))&&e instanceof g)return e;return null}getMode(){return this.mode}setMode(t){this.mode=t}getName(){return this.name}static floorCoord(t){return Math.floor(t/l.SIZE)*l.SIZE}static roundCoord(t){return Math.round(t/l.SIZE)*l.SIZE}static roundCoords([t,e]){return[this.roundCoord(t),this.roundCoord(e)]}static floorCoords([t,e]){return[this.floorCoord(t),this.floorCoord(e)]}setName(t){this.name=t}}const R=new j,k=R;var B=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class D extends g{constructor(t){var{index:e,spin:i}=t,s=B(t,["index","spin"]);super(Object.assign(Object.assign({},s),{width:l.SIZE,height:l.SIZE,paintPriority:10,canMove:!0,canRotate:!1,frame:{index:e,textureId:"hole",columns:1,totalFrames:1,frameSize:60,delX:-5,delY:-5,spin:i},group:[D]}))}update(){this.setFrameProperty("spin",(this.getFrameProperty("spin")-10)%-360)}onWormHeadCollide(t,e){const i=e,s=i.getWorm(),n=i.getWorm().getPieces().slice().reverse(),r=this.copy(),o=this.copy(),a=j.floorCoord(this.getX()-t.getX()),h=j.floorCoord(this.getY()-t.getY());return n.push(this,r.setX(r.getX()+a).setY(r.getY()+h),o.setX(o.getX()+2*a).setY(o.getY()+2*h)),i.setWonPiece(n),n.map(((t,e)=>n.slice(e+1).map((t=>({x:t.getX(),y:t.getY()}))))).forEach(((t,e)=>n[e].setChainTransition(t,(()=>{s.checkQueueFrame(),s.checkEndFrame()})))),s.checkHeadFrame([s.getHead().getFrameProperty("frameX"),s.getHead().getFrameProperty("frameY")],[s.getHead().getNextX(),s.getHead().getNextY()]),M.playAudio(M.WIN_AUDIOS),!0}}const W=[{name:"worm",columns:1,amount:1,size:50,img:document.getElementById("worm")},{name:"apple",columns:1,amount:1,size:55,img:document.getElementById("apple")},{name:"block",columns:6,amount:34,size:50,img:document.getElementById("block")},{name:"stone",columns:1,amount:1,size:50,img:document.getElementById("stone")},{name:"skewers",columns:1,amount:1,size:50,img:document.getElementById("skewers")},{name:"hole",columns:1,amount:1,size:60,img:document.getElementById("hole")}];const z=new class{constructor(){this.prevX=0,this.prevY=0,this.closed=!0,this.mousePress=!1,this.gameItemSelected=null,this.menu=document.getElementById("menu"),this.menuItems=document.getElementById("menu-items"),this.menuButton=document.getElementById("menu-button"),document.addEventListener("mousemove",(({clientX:t,clientY:e})=>{const{top:i,left:s}=this.menu.getBoundingClientRect();this.mousePress&&t&&e&&(this.menu.style.top=`${i+(e-this.prevY)}px`,this.menu.style.left=`${s+(t-this.prevX)}px`),this.prevX=t,this.prevY=e})),document.addEventListener("mousedown",(t=>{var e,i;t.target.matches("#menu-button")?(this.menuButton.textContent=this.closed?"-":"+",this.menu.classList.toggle("menu-close"),this.closed=!this.closed):t.target.closest("#menu-nav")?this.mousePress=!0:t.target.matches(".item")&&t.target instanceof HTMLImageElement&&(t.target===this.selectedItem?(null===(e=this.selectedItem)||void 0===e||e.classList.remove("item-selected"),this.selectedItem=void 0):(t.target.classList.add("item-selected"),null===(i=this.selectedItem)||void 0===i||i.classList.remove("item-selected"),this.selectedItem=t.target))})),document.addEventListener("mouseup",(()=>{this.mousePress=!1})),W.forEach((({img:t,amount:e,columns:i,size:s,name:n})=>{const r=document.createElement("canvas");r.width=s,r.height=s;const o=r.getContext("2d");let a=new Image;a.src=t.src,a.onload=()=>{for(let c=1;c<=e;c++){const{x:e,y:l}=this.getFrameCoordinates(c,i,s);o.drawImage(a,e,l,s,s,0,0,s,s);var t=r.toDataURL("image/png"),h=document.createElement("img");h.src=t,h.draggable=!1,h.classList.add("item"),h.dataset.index=c.toString(),h.dataset.name=n,o.clearRect(0,0,s,s),this.menuItems.appendChild(h)}}})),this.hide()}getFrameCoordinates(t,e,i){return{x:(t-1)%e*i,y:Math.floor((t-1)/e)*i}}getSelectedItem(){return this.selectedItem}getGameSelectedItem(){return this.gameItemSelected}hide(){this.menu.classList.add("display-none")}show(){this.menu.classList.remove("display-none")}setGameSelectedItem(t){this.gameItemSelected=t}};var Z=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};class G extends g{constructor(t){var{index:e,spin:i}=t,s=Z(t,["index","spin"]);super(Object.assign(Object.assign({},s),{paintPriority:99,width:l.SIZE,height:l.SIZE,canMove:!0,canRotate:!0,frame:{index:e,textureId:"skewers",columns:1,frameSize:50,spin:i},group:[G]})),this.setFrameBySpin()}rotate(){super.rotate(),this.setFrameBySpin()}setFrameBySpin(){const t=this.getFrameProperty("spin");90===t?(this.setFrameProperty("delX",-10),this.setFrameProperty("delY",3)):180===t?(this.setFrameProperty("delX",0),this.setFrameProperty("delY",0)):270===t?(this.setFrameProperty("delX",0),this.setFrameProperty("delY",3)):(this.setFrameProperty("delX",0),this.setFrameProperty("delY",10))}onWormHeadCollide(t,e){return e.setStop(!0).getWorm().setFalling(!1),t.setFrameProperty("index",5),!0}static hasCollision(){var t;for(let e of(null===(t=k.getWorm())||void 0===t?void 0:t.getPieces())||[])for(let t of G.getAllItems())if(i.matchLocation(j.floorCoords(e.getLocation()),j.floorCoords(t.getLocation())))return k.setStop(!0),k.getWorm().getHead().setFrameProperty("index",5),!0;return!1}}const _={apple:p,block:f,worm:C,stone:T,skewers:G,hole:D},U=document;class ${constructor(){if(this.page=0,this.buttonsContainer=U.getElementById("grid-container"),this.listLevelsButton=U.getElementById("list-button"),!this.buttonsContainer)throw new Error("grid-container not found");this.buttons=new Array($.TOTAL_LEVELS).fill(1).map(((t,e)=>{const i=U.createElement("button");return i.dataset.level=(e+1).toString(),i.textContent=(e+1).toString(),i}));const t=U.createDocumentFragment();this.buttons.slice(this.page*$.PASS,this.page*$.PASS+$.PASS).forEach((e=>t.appendChild(e))),this.buttonsContainer.appendChild(t),this.buttonsContainer.addEventListener("click",(t=>{const e=t.target;if(e instanceof HTMLButtonElement){const t=parseInt(e.dataset.level);fetch(`${$.LEVELS_ROUTE}/level-${t}.json`).then((t=>t.json())).then((t=>k.loadJSON(t,_))),this.hide()}})),this.listLevelsButton.addEventListener("click",(()=>this.isHidden()?this.show():this.hide())),U.addEventListener("keydown",(t=>{if(k.getMode()===H.EDITOR||k.getMode()===H.NONE)return;if("e"===t.key)return this.buttonsContainer.classList.toggle("hidden");if(this.isHidden())return;if("ArrowLeft"===t.key&&this.page>0)this.page--;else{if(!("ArrowRight"===t.key&&this.page*$.PASS+$.PASS<$.TOTAL_LEVELS))return;this.page++}this.buttonsContainer.innerHTML="";const e=U.createDocumentFragment();this.buttons.slice(this.page*$.PASS,this.page*$.PASS+$.PASS).forEach((t=>e.appendChild(t))),this.buttonsContainer.appendChild(e)}))}hide(){this.buttonsContainer.classList.add("hidden")}show(){this.buttonsContainer.classList.remove("hidden")}isHidden(){return this.buttonsContainer.classList.contains("hidden")}}$.PASS=15,$.TOTAL_LEVELS=32,$.LEVELS_ROUTE="assets/levels/";const J=new $;var V=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};class Q{constructor({container:t}){this.content=null,this.container=t}getContent(){return this.content}injectHTML(t){return V(this,arguments,void 0,(function*(t,e={}){return yield this.load(t),this.content&&(this.container.innerHTML=Object.keys(e).reduce(((t,i)=>t.replace(new RegExp(`\\\${${i}}`,"g"),e[i])),this.content)),this}))}getContainer(){return this.container}removeHTML(){this.container.innerHTML=""}load(t){return V(this,void 0,void 0,(function*(){const e=yield fetch(`${Q.COMPONENTS_PATH}/${t}.html`);return this.content=yield e.text(),this}))}}Q.COMPONENTS_PATH="components",Q.PARENT_NODE_TAG=/<\s*(\w+)[^>]*>([\s\S]*)<\/\s*\1\s*>/;const q=new Q({container:document.getElementById("ui")});var K=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};e.init({id:"root",width:1280,height:720});let tt=!1;function et(){if(tt)return;tt=!0,k.loadItemConstructor(f,T,C,G,p,D,N);const t={ArrowLeft:-50,ArrowRight:50,ArrowUp:-50,ArrowDown:50};document.addEventListener("keydown",(e=>{const i=z.getGameSelectedItem();if("Backspace"===e.key&&null!==i){if(!(i instanceof C))return k.remove(i);const t=C.getAllItems().findIndex((t=>t===i));C.getAllItems().splice(t).forEach((t=>k.remove(t))),M.orderFrames(C.getAllItems())}if("g"===e.key&&null!==i&&(null==i?void 0:i.getCanRotate()))return i.rotate();const s=k.getWorm();if(!J.isHidden()||k.getStop()||void 0===t[e.key]||s.isMoving()||s.isFalling()||k.getMode()===H.EDITOR)return;let n=t[e.key];const r="ArrowLeft"===e.key||"ArrowRight"===e.key?n:0,o="ArrowUp"===e.key||"ArrowDown"===e.key?n:0,a=s.getHead(),[h,c]=a.getLocation();if(o<0&&s.isVertical())return;const l=k.getFrom([h+r,c+o]);if(!(l instanceof g)||l.onWormHeadCollide(a,k)){if(!(l instanceof D)){let t=[h,c];if(a.setFrameProperty("syncLocation",!1),r){const t=a.copy().setLocation(h+r,c+o);t.setOpacity(0),k.add(t),a.setTransitionX(h+n,!0,(()=>{l instanceof p&&k.remove(l),a.setFrameProperty("syncLocation",!0),k.remove(t)}))}else n<0?(a.setFrameProperty("syncLocation",!0),a.setTransitionY(c+n,!1,(()=>{l instanceof p&&k.remove(l)}))):a.setTransitionY(c+n,!0,(()=>{l instanceof p&&k.remove(l),a.setFrameProperty("syncLocation",!0)}));s.getQueue().forEach(((e,i)=>{e.setFrameProperty("syncLocation",!1);let n=e.getLocation();const r=()=>{i===s.getQueue().length-1&&!(l instanceof G)&&s.setFalling(!0),e.setFrameProperty("syncLocation",!0)};e.setTransitionX(t[0],!0,r),e.setTransitionY(t[1],!0,r),t=n})),s.checkHeadFrame(a.getLocation(),[a.getNextX(),a.getNextY()])}s.checkQueueFrame(),s.checkEndFrame()}})),k.execute((()=>{var t,i;if(k.get().sort(((t,e)=>t.getPaintPriority()>e.getPaintPriority()||t.getY()<e.getY()&&t.getPaintPriority()===e.getPaintPriority()||t.getX()>e.getX()&&t.getPaintPriority()===e.getPaintPriority()?1:-1)),null===(t=k.getWorm())||void 0===t||t.update(),!k.getStop())return G.hasCollision(),(null===(i=k.getWorm())||void 0===i?void 0:i.getPieces().every((t=>t.getY()-100>e.getCanvas().height)))?k.setStop(!0).loadJSON(k.getLoadedJSON(),_):void 0})),P.addListener("mousedown",(({clientX:t,clientY:e})=>{var i,s;if(k.getMode()!==H.EDITOR)return;const n=k.getFrom(j.floorCoords([t,e]));if(n&&z.getGameSelectedItem()===n)return null===(i=z.getGameSelectedItem())||void 0===i||i.setIsDebug(!1),void z.setGameSelectedItem(null);if(n)return null===(s=z.getGameSelectedItem())||void 0===s||s.setIsDebug(!1),n.setIsDebug(!0),void z.setGameSelectedItem(n);if(!z.getSelectedItem())return;const r=[Math.floor(t/l.SIZE),Math.floor(e/l.SIZE)],{name:o,index:a}=z.getSelectedItem().dataset,h=new _[o]({x:r[0],y:r[1],index:parseInt(a)});if(h instanceof C&&C.getAllItems().length>1){if(2===C.getAllItems().length){const t=C.getAllItems().at(-2),e=t.getDistanceX(h),i=t.getDistanceY(h);M.checkHeadFrame(t.getLocation(),[t.getX()+e,t.getY()+i],t)}else{const t=C.getAllItems().at(-2),e=Math.abs(t.getDistanceX(h)),i=Math.abs(t.getDistanceY(h));if(e>50||i>50||0!==e&&0!==i)return C.getAllItems().splice(C.getAllItems().length-1,1)}M.orderFrames(C.getAllItems())}else h instanceof T&&h.getGravity().setIsEnabled(!1);if(h.getCanMove()){const t=new I({target:h,encapsulate:!0,onNewLocation:e=>{k.getFrom(j.roundCoords([e.x,e.y]))?h.setLocation(t.getPrevLocation().x,t.getPrevLocation().y):h.setLocation(...j.roundCoords([e.x,e.y]))}})}k.add(h)}))}document.addEventListener("DOMContentLoaded",(()=>K(void 0,void 0,void 0,(function*(){var t,i;yield q.injectHTML("menu"),null===document||void 0===document||document.addEventListener("click",(t=>K(void 0,void 0,void 0,(function*(){t.target instanceof HTMLButtonElement&&(t.target.matches("#start")?(k.setMode(H.NORMAL),z.hide(),J.show(),et(),q.getContainer().classList.add("display-none"),q.removeHTML()):t.target.matches("#editor")&&(k.setMode(H.EDITOR),J.hide(),yield q.injectHTML("input")))})))),document.addEventListener("submit",(t=>{t.preventDefault();const i=t.target,s=parseInt(i.width.value),n=parseInt(i.height.value),r=i.name.value.toString();r.length<=0||r.length>100||s<300||n<300||s>3e3||n>2e3||(e.getCanvas().width=s,e.getCanvas().height=n,k.setName(r),k.resizeCanvas(),z.show(),et(),q.removeHTML(),k.loadJSON({name:r,resolution:{width:s,height:n},items:{worm:[]}},_),q.getContainer().classList.add("display-none"))}));const s=document.getElementById("export-button"),n=document.getElementById("import-button"),r=document.getElementById("import-file");null==s||s.addEventListener("click",(()=>{const t=document.createElement("a"),e=new Blob([JSON.stringify(k.getJSON(_))],{type:"application/json"});t.href=URL.createObjectURL(e),t.download=k.getName()+".json",t.click(),URL.revokeObjectURL(t.href)})),null==n||n.addEventListener("click",(()=>null==r?void 0:r.click())),null==r||r.addEventListener("change",(()=>K(void 0,void 0,void 0,(function*(){var t;(null===(t=r.files)||void 0===t?void 0:t.length)&&k.loadJSON(JSON.parse(yield r.files[0].text()),_)}))));const o=()=>{k.getLoadedJSON()&&k.setStop(!0).loadJSON(k.getLoadedJSON(),_)};null===(t=document.getElementById("reload-button"))||void 0===t||t.addEventListener("click",(()=>k.getMode()!==H.NONE&&o())),document.addEventListener("keydown",(t=>"r"===t.key&&k.getMode()!==H.NONE&&o())),k.resizeCanvas(),window.addEventListener("resize",k.resizeCanvas),null===(i=document.getElementById("back-button"))||void 0===i||i.addEventListener("click",(()=>{J.hide(),z.hide(),k.reset(),q.injectHTML("menu"),q.getContainer().classList.remove("display-none"),k.setMode(H.NONE)}))}))))})();